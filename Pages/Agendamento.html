<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link href="../Style/styleAgendamento.css" rel="stylesheet">
  <title>Agendamento</title>
</head>

<script>
  const tipoServico = localStorage.getItem('Servico');
  const precoServico = localStorage.getItem('PrecoServico')
  window.data = '';
  window.hora = '';

  window.onload = function () {
    document.getElementById("header-servico").textContent = tipoServico;
    document.getElementById('valor-servico').value = precoServico;
    document.getElementById("data").setAttribute('min', new Date().toISOString().split('T')[0]);

    desabilitarDatasReservadas();
  }

  function bloquearData() {
    const dataSelecionada = new Date(document.getElementById("data").value);
    const inputHora = document.getElementById("time");
    const horasDisponiveis = ['8:00', '8:30', '9:00', '9:30', '10:00', '10:30', '11:00', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00'];

    const hoje = new Date(); // Data atual
    hoje.setHours(0, 0, 0, 0); // Define para a meia-noite

    const dataEscolhida = new Date(dataSelecionada);
    dataEscolhida.setHours(0, 0, 0, 0); // Define para a meia-noite

    if (dataEscolhida < hoje) {
      document.getElementById("data").value = '';
      alert("Escolha uma data futura.");
      return;
    }

    document.getElementById("data").setAttribute('min', hoje.toISOString().split('T')[0]);

    const reservasSalvas = localStorage.getItem('DatasReservadas');
    const datasReservadas = reservasSalvas ? JSON.parse(reservasSalvas) : [];

    if (datasReservadas.includes(dataSelecionada.toISOString().split('T')[0])) {
      alert("Essa data já foi reservada.");
      document.getElementById("data").value = ''; // Limpa a seleção da data
      return;
    } else {
      datasReservadas.push(dataSelecionada.toISOString().split('T')[0]);
      localStorage.setItem('DatasReservadas', JSON.stringify(datasReservadas));
    }

    inputHora.innerHTML = '';
    horasDisponiveis.forEach(hora => {
      const option = document.createElement('option');
      option.text = hora;
      inputHora.add(option);
    });

    if (dataEscolhida.getTime() === hoje.getTime()) {
      const horaAtual = new Date().getHours();
      for (let i = 0; i < horasDisponiveis.length; i++) {
        const hora = parseInt(horasDisponiveis[i].split(':')[0]);
        if (hora < horaAtual) {
          inputHora.remove(0);
        } else {
          break;
        }
      }
    }
  }

  function atualizarInformacoes() {
    bloquearData();
    var date = new Date(document.getElementById("data").value);
    date.setHours(date.getHours() - 3);

    var dd = String(date.getDate() + 1).padStart(2, '0');
    var mm = String(date.getMonth() + 1).padStart(2, '0');
    var yyyy = date.getFullYear();

    window.data = today = dd + '/' + mm + '/' + yyyy;
    document.getElementById('service-data').textContent = window.data;

    window.hora = document.getElementById("time").value;
    document.getElementById('service-hora').textContent = window.hora;
  }
  function Agendar(nomeServico) {
    event.preventDefault();
    if (!localStorage['Auth']) {
      document.location.href = './Login.html'
      return;
    }

    function atualizarHoras() {
      const inputHora = document.getElementById("time");
      const horaSelecionada = new Date(document.getElementById("data").value);
      const horaAtual = new Date();

      const horasDisponiveis = [];

      // Lógica para calcular as horas disponíveis
      if (horaSelecionada.toDateString() === horaAtual.toDateString()) {
        const hora = horaAtual.getHours();
        const minutos = horaAtual.getMinutes();

        for (let i = hora + 1; i <= 17; i++) {
          const horaFormatada = `${i.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
          horasDisponiveis.push(horaFormatada);
        }
      } else {
        for (let i = 8; i <= 17; i++) {
          const horaFormatada = `${i.toString().padStart(2, '0')}:00`;
          horasDisponiveis.push(horaFormatada);
        }
      }

      inputHora.innerHTML = '';
      horasDisponiveis.forEach(hora => {
        const option = document.createElement('option');
        option.text = hora;
        inputHora.add(option);
      });
    }

    if (tipoServico && window.data && window.hora) {
      // Use && em vez de &
      const mensagemPreSelecionada = `Olá, eu quero agendar meu serviço:\n*Tipo de serviço:* ${tipoServico}\n*Data marcada:* ${window.data}\n*Horário marcado:* ${window.hora}`

      // Substitua o número de telefone abaixo pelo número correto
      const numeroTelefone = "557999506852"

      const mensagemCodificada = encodeURIComponent(mensagemPreSelecionada)

      const linkWhatsApp = `https://api.whatsapp.com/send?phone=${numeroTelefone}&text="${mensagemCodificada}"`
      var w1 = window.open(linkWhatsApp, '_blank').focus();
    } else {
      console.log("Dados necessários não estão definidos no localStorage.")
    }
  }
</script>

<body class="body">
  <nav class="navbar navbar-expand-lg " id="Nav">
    <div class="container-fluid">
      <a class="navbar-brand" id="Link" href="../Pages/Index.html"><img src="../Assets/logo1.png" alt=""
          id="imgLogo"></a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
        aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav" id="NavLink">
          <a class="nav-link active" id="Link" aria-current="page" href="Index.html">Home</a>
          <a class="nav-link active" id="Link" href="Servico.html">Serviços</a>
          <a class="nav-link active" id="Link" href="./Index.html#faleconosco">Fale Conosco</a>
        </div>
        <a class="navbar-brand" id="Link" href="#"><img src="../Assets/logout2.png" alt="Logout" id="logoutBtn"></a>
      </div>
    </div>
  </nav>
  <br>
  <br>
  <h2 id="Title1">Agende seu Serviço</h2>
  <div class="container overflow-hidden text-center">
    <div class="row gx-5">
      <div class="col">
        <div class="p-3">
          <form class="row g-3 needs-validation" id="Form">
            <div class="col-md-6" id="label">
              <label for="nome" class="form-label">Data</label>
              <input type="date" onchange="atualizarInformacoes()" class="form-control" name="data" id="data" min=""
                required>
              <br>
              <label for="cpf" class="form-label">Horas</label>
              <select class="form-select" onchange="atualizarHoras()" id="time" required>
                <option value="">Selecione um horário</option>
              </select>
              <br>
            </div>
          </form>
        </div>
      </div>
      <div class="col">
        <div class="p-3">
          <div class="card" id="Form2">
            <h5 class="card-header" id="header-servico"></h5>
            <div class="card-body">
              <!-- <label for="tipo-servico" class="form-label">Tipo de serviço</label>
              <select class="form-select mb-3" id="tipo-servico" required>
                <option value="">Selecione o tipo de serviço</option>
                <option value="Lavagem externa">Lavagem externa</option>
                <option value="Lavagem interna">Lavagem interna</option>
                <option value="Polimento">Polimento</option>
              </select> -->


              <label for="detalhes-carro" class="form-label">Detalhes adicionais do carro</label>
              <textarea class="form-control mb-3" id="detalhes-carro" rows="3"
                placeholder="Descreva detalhes específicos sobre o carro"></textarea>

              <label for="valor-servico" class="form-label">Valor do serviço</label>
              <div class="input-group mb-3">
                <span class="input-group-text" id="valor-prefixo">R$</span>
                <input type="text" class="form-control" placeholder="100" id="valor-servico" disabled>
              </div>

              <a target="_blank" class="btn btn-primary" id="btn3" onclick="Agendar()">Agendar</a>
            </div>
          </div>
        </div>
      </div>


    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
      crossorigin="anonymous"></script>
    <script src="../utils/logout.js"></script>
</body>

</html>